import random
import os
#clase y jugador 
class Jugador:
    def __init__(self, nombres, identificacion, edad, usuario, password, rol="jugador"):
        self.nombres = nombres
        self.identificacion = identificacion
        self.edad = edad
        self.usuario = usuario
        self.password = password
        self.rol = rol

    def __str__(self):
        return f"Usuario: {self.usuario} | Nombre: {self.nombres} | Rol: {self.rol}"

    def a_cadena(self):
        """Convierte el objeto Jugador a una cadena para guardar en .txt"""
        return f"{self.nombres},{self.identificacion},{self.edad},{self.usuario},{self.password},{self.rol}\n"
    #co el @classmethod
    def desde_cadena(cls, cadena):
        """Crea un objeto Jugador desde una cadena de .txt"""
        partes = cadena.strip().split(',')
        if len(partes) == 6:
            nombres, identificacion, edad, usuario, password, rol = partes
            jugador = cls(nombres, identificacion, int(edad), usuario, password, rol)
            return jugador
        elif len(partes) == 8: # Para compatibilidad con archivos viejos
            nombres, identificacion, edad, usuario, password, rol, _, _ = partes
            jugador = cls(nombres, identificacion, int(edad), usuario, password, rol)
            return jugador
        return None
#nodos de arbol de habilidades
class NodoHabilidad:
    def __init__(self, nombre_habilidad, tipo_habilidad="generico", valor=0):
        self.nombre = nombre_habilidad
        self.tipo = tipo_habilidad
        self.valor = valor
        self.izquierda = None
        self.derecha = None

     def __str__(self):
        return f"Habilidad: {self.nombre} ({self.tipo}, Valor: {self.valor})"
        
class ArbolBinarioHabilidades:
    def __init__(self):
        self.raiz = None

    def insertar_habilidad(self, nombre, tipo, valor):
        """Inserta una nueva habilidad en el árbol (implementación simple de BST por nombre)."""
        nuevo_nodo = NodoHabilidad(nombre, tipo, valor)
        if self.raiz is None:
            self.raiz = nuevo_nodo
        else:
            self._insertar_recursivo(self.raiz, nuevo_nodo)

    def _insertar_recursivo(self, nodo_actual, nuevo_nodo):
        if nuevo_nodo.nombre.lower() == nodo_actual.nombre.lower():
            return
        elif nuevo_nodo.nombre.lower() < nodo_actual.nombre.lower():
            if nodo_actual.izquierda is None:
                nodo_actual.izquierda = nuevo_nodo
            else:
                self._insertar_recursivo(nodo_actual.izquierda, nuevo_nodo)
        else:
            if nodo_actual.derecha is None:
                nodo_actual.derecha = nuevo_nodo
            else:
                self._insertar_recursivo(nodo_actual.derecha, nuevo_nodo)
def recorrido_inorden(self):
        """Devuelve una lista de nombres de habilidades en recorrido inorden (Izquierda, Raíz, Derecha)."""
        habilidades = []
        self._inorden_recursivo(self.raiz, habilidades)
        return habilidades

    def _inorden_recursivo(self, nodo, habilidades):
        if nodo:
            self._inorden_recursivo(nodo.izquierda, habilidades)
            habilidades.append(nodo.nombre)
            self._inorden_recursivo(nodo.derecha, habilidades)

    def obtener_habilidades_planas(self):
        """Devuelve todas las habilidades del árbol como una lista de tuplas (nombre, tipo, valor)."""
        habilidades_planas = []
        self._inorden_habilidades_con_tipo_recursivo(self.raiz, habilidades_planas)
        return habilidades_planas

    def _inorden_habilidades_con_tipo_recursivo(self, nodo, habilidades_planas):
        if nodo:
            self._inorden_habilidades_con_tipo_recursivo(nodo.izquierda, habilidades_planas)
            habilidades_planas.append((nodo.nombre, nodo.tipo, nodo.valor))
            self._inorden_habilidades_con_tipo_recursivo(nodo.derecha, habilidades_planas)

    def obtener_habilidades_por_valor(self):
        """Devuelve todas las habilidades del árbol como una lista de tuplas (nombre, tipo, valor), ordenadas por valor descendente."""
        habilidades_planas = self.obtener_habilidades_planas()
        return sorted(habilidades_planas, key=lambda x: x[2], reverse=True)

    @classmethod
    def desde_habilidades_planas(cls, lista_habilidades_info):
        """Crea un nuevo árbol e inserta habilidades desde una lista de (nombre, tipo, valor)."""
        nuevo_arbol = cls()
        for item in lista_habilidades_info:
            if len(item) == 3:
                nombre, tipo, valor = item
                nuevo_arbol.insertar_habilidad(nombre, tipo, int(valor))
        return nuevo_arbol

    def buscar_habilidad(self, nombre):
        """Busca una habilidad por nombre en el árbol. Retorna el NodoHabilidad si lo encuentra, None en caso contrario."""
        return self._buscar_recursivo(self.raiz, nombre)

    def _buscar_recursivo(self, nodo, nombre_buscar):
        if nodo is None or nodo.nombre.lower() == nombre_buscar.lower():
            return nodo
        if nombre_buscar.lower() < nodo.nombre.lower():
            return self._buscar_recursivo(nodo.izquierda, nombre_buscar)
        else:
            return self._buscar_recursivo(nodo.derecha, nombre_buscar)
    def eliminar_habilidad(self, nombre):
        """Elimina una habilidad por su nombre del árbol. Retorna True si se eliminó, False en caso contrario."""
        if not self.buscar_habilidad(nombre):
            return False
        self.raiz = self._eliminar_recursivo(self.raiz, nombre)
        return True

    def _eliminar_recursivo(self, nodo_actual, nombre_a_eliminar):
        if nodo_actual is None:
            return nodo_actual

        if nombre_a_eliminar.lower() < nodo_actual.nombre.lower():
            nodo_actual.izquierda = self._eliminar_recursivo(nodo_actual.izquierda, nombre_a_eliminar)
        elif nombre_a_eliminar.lower() > nodo_actual.nombre.lower():
            nodo_actual.derecha = self._eliminar_recursivo(nodo_actual.derecha, nombre_a_eliminar)
        else: # Nodo encontrado
            if nodo_actual.izquierda is None:
                return nodo_actual.derecha
            elif nodo_actual.derecha is None:
                return nodo_actual.izquierda

            temp = self._encontrar_min_valor_nodo(nodo_actual.derecha)
            nodo_actual.nombre = temp.nombre
            nodo_actual.tipo = temp.tipo
            nodo_actual.valor = temp.valor
            nodo_actual.derecha = self._eliminar_recursivo(nodo_actual.derecha, temp.nombre)
        return nodo_actual

    def _encontrar_min_valor_nodo(self, nodo):
        actual = nodo
        while actual.izquierda is not None:
            actual = actual.izquierda
        return actual
#se usara esta clase pra ninjas
class Ninja:
    def __init__(self, nombre, fuerza, agilidad, resistencia, estilo):
        self.nombre = nombre
        self.fuerza = fuerza
        self.agilidad = agilidad
        self.resistencia = resistencia
        self.estilo = estilo
        self.puntos_victoria = 0.0
        self.habilidades = ArbolBinarioHabilidades()
        self.vida_actual = 500 # ¡VIDA VUELVE A 500 HP!

    def __str__(self):
        return f"Ninja: {self.nombre} | Fuerza: {self.fuerza} | Agilidad: {self.agilidad} | Resistencia: {self.resistencia} | Estilo: {self.estilo} | PV: {self.puntos_victoria:.1f}"

    def a_cadena(self):
        """Convierte el objeto Ninja a una cadena para guardar en .txt, incluyendo habilidades."""
        habilidades_planas = self.habilidades.obtener_habilidades_planas()
        habilidades_str = ";".join([f"{n}|{t}|{v}" for n, t, v in habilidades_planas])
        return (f"{self.nombre},{self.fuerza},{self.agilidad},{self.resistencia},"
                f"{self.estilo},{self.puntos_victoria},{habilidades_str}\n")
    @classmethod
    def desde_cadena(cls, cadena):
        """Crea un objeto Ninja desde una cadena de .txt, reconstruyendo el árbol de habilidades."""
        partes = cadena.strip().split(',')
        if len(partes) == 7:
            nombre, fuerza, agilidad, resistencia, estilo, puntos_victoria_str, habilidades_str = partes
            ninja = cls(nombre, int(fuerza), int(agilidad), int(resistencia), estilo)
            ninja.puntos_victoria = float(puntos_victoria_str)

            if habilidades_str:
                habilidades_cargadas = []
                for habilidad_info in habilidades_str.split(';'):
                    if habilidad_info:
                        h_partes = habilidad_info.split('|')
                        if len(h_partes) == 3:
                            habilidades_cargadas.append((h_partes[0], h_partes[1], int(h_partes[2])))
                ninja.habilidades = ArbolBinarioHabilidades.desde_habilidades_planas(habilidades_cargadas)
            return ninja
        return None
# GESTIÓN DE ARCHIVOS
ARCHIVO_USUARIOS = "usuarios.txt"
ARCHIVO_NINJAS = "ninjas.txt"
ARCHIVO_COMBATES_GLOBAL = "combates_global.txt" # Para historial global de combates

def cargar_usuarios():
    """Carga los usuarios registrados desde usuarios.txt."""
    usuarios = []
    try:
        with open(ARCHIVO_USUARIOS, 'r') as f:
            for linea in f:
                usuario = Jugador.desde_cadena(linea)
                if usuario:
                    usuarios.append(usuario)
    except FileNotFoundError:
        pass # No mostrar advertencia si no existe al inicio
    except Exception as e:
        print(f"Error al cargar usuarios: {e}")
    return usuarios

def guardar_usuarios(usuarios):
    """Guarda la lista de usuarios en usuarios.txt."""
    try:
        with open(ARCHIVO_USUARIOS, 'w') as f:
            for usuario in usuarios:
                f.write(usuario.a_cadena())
    except Exception as e:
        print(f"Error al guardar usuarios: {e}")

def cargar_ninjas():
    """Carga los ninjas desde ninjas.txt."""
    ninjas = []
    try:
        with open(ARCHIVO_NINJAS, 'r') as f:
            for linea in f:
                ninja = Ninja.desde_cadena(linea)
                if ninja:
                    ninjas.append(ninja)
    except FileNotFoundError:
        pass # No mostrar advertencia si no existe al inicio
    except Exception as e:
        print(f"Error al cargar ninjas: {e}")
    return ninjas

def guardar_ninjas(ninjas):
    """Guarda la lista de ninjas en ninjas.txt."""
    try:
        with open(ARCHIVO_NINJAS, 'w') as f:
            for ninja in ninjas:
                f.write(ninja.a_cadena())
    except Exception as e:
        print(f"Error al guardar ninjas: {e}")

def registrar_combate_global(log_combate):
    """Registra un combate en el historial global combates_global.txt."""
    try:
        with open(ARCHIVO_COMBATES_GLOBAL, 'a') as f:
            f.write(f"{log_combate}\n\n")
    except Exception as e:
        print(f"Error al registrar combate global: {e}")

def cargar_historial_global_combates():
    """Carga el historial global de combates desde combates_global.txt."""
    historial = []
    try:
        with open(ARCHIVO_COMBATES_GLOBAL, 'r') as f:
            contenido = f.read()
            combates = [c.strip() for c in contenido.split('\n\n') if c.strip()]
            historial.extend(combates)
    except FileNotFoundError:
        pass
    except Exception as e:
        print(f"Error al cargar historial de combates global: {e}")
    return historial

# listas
global_usuarios = []
global_ninjas = []
usuario_actual = None
ninja_seleccionado_jugador = None # ninja del jugador

#esta funcion es para que se limpie la consola
def limpiar_pantalla():
    """Limpia la consola."""
    os.system('cls' if os.name == 'nt' else 'clear')

def pausar_consola():
    """Pausa la ejecución de la consola hasta que el usuario presione Enter."""
    input("Presiona Enter para continuar...")

def buscar_ninja_por_nombre(nombre_buscar):
    """Busca un ninja en global_ninjas por su nombre (insensible a mayúsculas/minúsculas)."""
    for ninja in global_ninjas:
        if ninja.nombre.lower() == nombre_buscar.lower():
            return ninja
    return None

def registrar_nuevo_jugador():
    """Permite a un nuevo usuario registrarse en el sistema."""
    limpiar_pantalla()
    print("\n--- ¡Únete a la aventura ninja! REGISTRO ---")
    nombres = input("Ingresa tus nombres y apellidos: ").strip()
    identificacion = input("Ingresa tu número de identificación: ").strip()
     while True:
            try:
                edad = int(input("Ingresa tu edad: ").strip())
                break
            except ValueError:
                print("¡Ups! Edad inválida. Por favor, ingresa un número.")
    
        while True:
            usuario_email = input("Ingresa tu correo electrónico (será tu usuario, ej. nombre.apellido@gmail.com): ").strip().lower()
            if "@" not in usuario_email or "." not in usuario_email:
                print("Formato de correo inválido. Asegúrate de incluir '@' y '.'")
            elif any(u.usuario == usuario_email for u in global_usuarios):
                print("Este correo ya está registrado. Intenta con otro o inicia sesión.")
            else:
                break
    while True:
            password = input("Ingresa una contraseña (mín. 8 caracteres, 1 mayúscula, 1 número): ").strip()
            if len(password) < 8:
                print("La contraseña debe tener al menos 8 caracteres.")
            elif not any(char.isupper() for char in password):
                print("La contraseña debe contener al menos una letra mayúscula.")
            elif not any(char.isdigit() for char in password):
                print("La contraseña debe contener al menos un número.")
            else:
                break
    
        nuevo_jugador = Jugador(nombres, identificacion, edad, usuario_email, password, "jugador")
        global_usuarios.append(nuevo_jugador)
        guardar_usuarios(global_usuarios)
        print("¡Registro exitoso! ¡Bienvenido a PoliNinjaGames! Ya puedes iniciar sesión.")
        pausar_consola()
        return True
def iniciar_sesion():
    """Permite a un usuario iniciar sesión y devuelve el objeto Jugador autenticado o None."""
    limpiar_pantalla()
    print("\n--- ¡Hora de la acción! INICIO DE SESIÓN ---")
    usuario_input = input("Tu usuario (correo electrónico): ").strip().lower()
    password_input = input("Tu contraseña secreta: ").strip()

    for user in global_usuarios:
        if user.usuario == usuario_input and user.password == password_input:
            print(f"¡Bienvenido de nuevo, {user.nombres}! Prepárate para la batalla.")
            pausar_consola()
            return user

    print("Usuario o contraseña incorrectos. ¡Revisa bien e intenta de nuevo!")
    pausar_consola()
    return None

# FUNCIONES PARA MENÚ DE ADMINISTRADOR

def solicitar_datos_ninja(modo_edicion=False, ninja_existente=None):
    """Solicita los datos para crear o editar un ninja."""
    print("\n--- ¡Creando o ajustando un poderoso Ninja! ---")

    nombre_ninja = input(f"Nombre del Ninja (actual: {ninja_existente.nombre}, deja en blanco para mantener si editas): ").strip() if modo_edicion and ninja_existente else input("Nombre del Ninja: ").strip()

    if not nombre_ninja and not modo_edicion:
        print("El nombre no puede estar vacío. ¡Operación cancelada!")
        return None
    elif not nombre_ninja and modo_edicion:
        nombre_ninja = ninja_existente.nombre

    if not modo_edicion:
        if any(n.nombre.lower() == nombre_ninja.lower() for n in global_ninjas):
            print("¡Uy! Ya existe un ninja con ese nombre. Por favor, elige otro. Operación cancelada.")
            return None
    elif modo_edicion and ninja_existente.nombre.lower() != nombre_ninja.lower():
        if any(n.nombre.lower() == nombre_ninja.lower() and n is not ninja_existente for n in global_ninjas):
            print("¡Error! El nuevo nombre ya está ocupado por otro ninja. Por favor, elige otro. Operación cancelada.")
            return None

    def leer_atributo(nombre_atributo, valor_actual=None):
        while True:
            valor_current = valor_actual if valor_actual is not None else "N/A"
            prompt = f"Ingresa {nombre_atributo} (valor del 1 al 100, actual: {valor_current}): " if valor_actual is not None else f"Ingresa {nombre_atributo} (valor del 1 al 100): "
            valor_str = input(prompt).strip()
            if modo_edicion and valor_str == "":
                return valor_actual
            try:
                valor = int(valor_str)
                if 1 <= valor <= 100:
                    return valor
                else:
                    print("¡Cuidado! El valor debe estar entre 1 y 100.")
            except ValueError:
                print("¡Error! Ingresa un número válido, por favor.")
    fuerza = leer_atributo("Fuerza", ninja_existente.fuerza if modo_edicion and ninja_existente else None)
    agilidad = leer_atributo("Agilidad", ninja_existente.agilidad if modo_edicion and ninja_existente else None)
    resistencia = leer_atributo("Resistencia", ninja_existente.resistencia if modo_edicion and ninja_existente else None)

    estilos_validos = ["Taijutsu", "Ninjutsu", "Genjutsu", "Mixto"]
    estilo = ""
    while estilo not in estilos_validos:
        prompt_estilo = f"Estilo ({', '.join(estilos_validos)}) (actual: {ninja_existente.estilo if modo_edicion and ninja_existente else 'Ninguno'}): "
        estilo_input = input(prompt_estilo).strip().capitalize()

        if modo_edicion and estilo_input == "":
            estilo = ninja_existente.estilo
            break

        if estilo_input in estilos_validos:
            estilo = estilo_input
            break
        else:
            print(f"Estilo inválido. Por favor, elige uno de: {', '.join(estilos_validos)}")

    return (nombre_ninja, fuerza, agilidad, resistencia, estilo)

def agregar_nuevo_ninja():
    """Agrega un nuevo ninja a la lista global."""
    limpiar_pantalla()
    print("\n--- ¡Forjando un nuevo guerrero ninja! ---")
    datos_ninja = solicitar_datos_ninja(modo_edicion=False)
    if datos_ninja:
        nombre, fuerza, agilidad, resistencia, estilo = datos_ninja
        nuevo_ninja = Ninja(nombre, fuerza, agilidad, resistencia, estilo)
        global_ninjas.append(nuevo_ninja)
        print(f"¡Ninja '{nombre}' ha sido reclutado exitosamente! Recuerda guardar los cambios.")
    else:
        print("Operación de agregar ninja cancelada o fallida. ¡Intenta de nuevo!")
    pausar_consola()

def listar_ninjas():
    """Muestra todos los ninjas existentes."""
    print("\n--- Nuestros valientes Ninjas: ---")
    if not global_ninjas:
        print("¡Todavía no hay ninjas registrados en la aldea!")
        return

    ninjas_ordenados = sorted(global_ninjas, key=lambda ninja: ninja.nombre.lower())

    for i, ninja in enumerate(ninjas_ordenados):
        print(f"{i+1}. Nombre: {ninja.nombre}")
        print(f"   Fuerza: {ninja.fuerza}, Agilidad: {ninja.agilidad}, Resistencia: {ninja.resistencia}")
        print(f"   Estilo: {ninja.estilo}, Puntos de Victoria (PV): {ninja.puntos_victoria:.1f}")

        habilidades_nombres = ninja.habilidades.recorrido_inorden()
        if habilidades_nombres:
            print(f"   Habilidades: {', '.join(habilidades_nombres)}")
        else:
            print("   Habilidades: Ninguna aún...")
        print("-" * 30)
def consultar_ninja():
    """Permite al administrador consultar los detalles de un ninja específico."""
    limpiar_pantalla()
    print("\n--- Espiando los detalles de un Ninja... ---")
    if not global_ninjas:
        print("No hay ninjas registrados para investigar.")
        pausar_consola()
        return
    nombre_buscar = input("Ingresa el nombre del ninja que quieres consultar: ").strip()
    ninja_encontrado = buscar_ninja_por_nombre(nombre_buscar)

    if ninja_encontrado:
        print("\n--- Informe detallado del Ninja ---")
        print(f"Nombre: {ninja_encontrado.nombre}")
        print(f"Fuerza: {ninja_encontrado.fuerza}")
        print(f"Agilidad: {ninja_encontrado.agilidad}")
        print(f"Resistencia: {ninja_encontrado.resistencia}")
        print(f"Estilo: {ninja_encontrado.estilo}")
        print(f"Puntos de Victoria (PV): {ninja_encontrado.puntos_victoria:.1f}")
        habilidades_encontradas = ninja_encontrado.habilidades.obtener_habilidades_planas()
        if habilidades_encontradas:
            print("\nHabilidades (por nombre):")
            for nombre_h, tipo_h, valor_h in sorted(habilidades_encontradas, key=lambda x: x[0].lower()):
                print(f"- {nombre_h} (Tipo: {tipo_h}, Poder: {valor_h})")

            habilidades_por_valor = ninja_encontrado.habilidades.obtener_habilidades_por_valor()
            if habilidades_por_valor:
                print("\nHabilidades (por valor de poder):")
                for nombre_h, tipo_h, valor_h in habilidades_por_valor:
                    print(f"   - {nombre_h} (Tipo: {tipo_h}, Poder: {valor_h})")
        else:
            print("Habilidades: ¡Este ninja necesita aprender más jutsus!")
        print("-" * 30)
    else:
        print(f"Ninja '{nombre_buscar}' no encontrado. ¡Parece que no existe en esta aldea!")
    pausar_consola()
def actualizar_ninja():
    """Permite al administrador actualizar los atributos de un ninja existente."""
    limpiar_pantalla()
    print("\n--- ¡Mejorando un Ninja! ---")
    if not global_ninjas:
        print("No hay ninjas registrados para actualizar sus habilidades.")
        pausar_consola()
        return

    nombre_buscar = input("Ingresa el nombre del ninja que quieres actualizar: ").strip()
    ninja_a_actualizar = buscar_ninja_por_nombre(nombre_buscar)
    if ninja_a_actualizar:
        print(f"Ninja '{ninja_a_actualizar.nombre}' encontrado. ¡Vamos a mejorarlo!")
        print("Ingresa los nuevos datos (deja en blanco para mantener el actual):")

        nuevos_datos = solicitar_datos_ninja(modo_edicion=True, ninja_existente=ninja_a_actualizar)

        if nuevos_datos:
            nombre_nuevo, fuerza_nueva, agilidad_nueva, resistencia_nueva, estilo_nuevo = nuevos_datos

            ninja_a_actualizar.nombre = nombre_nuevo
            ninja_a_actualizar.fuerza = fuerza_nueva
            ninja_a_actualizar.agilidad = agilidad_nueva
            ninja_a_actualizar.resistencia = resistencia_nueva
            ninja_a_actualizar.estilo = estilo_nuevo

            print(f"¡Ninja '{ninja_a_actualizar.nombre}' actualizado con éxito! No olvides guardar los cambios.")
        else:
            print("Actualización de ninja cancelada o fallida. ¡A veces, el destino no quiere cambios!")
    else:
        print(f"Ninja '{nombre_buscar}' no encontrado para actualizar.")
    pausar_consola()
